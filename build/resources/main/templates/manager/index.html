<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <title>SAHAM Assurance Vie | ESPACE CLIENT</title>
    <meta charset="utf-8">
    <meta content="ie=edge" http-equiv="x-ua-compatible">
    <meta content="template language" name="keywords">
    <meta content="Tamerlan Soziev" name="author">
    <meta content="Admin dashboard html template" name="description">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="../s/favicon.png" rel="shortcut icon">
    <link href="../apple-touch-icon.png" rel="apple-touch-icon">
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,500" rel="stylesheet" type="text/css">
    <link href="../bower_components/select2/dist/css/select2.min.css" rel="stylesheet">
    <link href="../bower_components/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <link href="../bower_components/dropzone/dist/dropzone.css" rel="stylesheet">
    <link href="../bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../bower_components/fullcalendar/dist/fullcalendar.min.css" rel="stylesheet">
    <link href="../bower_components/perfect-scrollbar/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.1.5/css/iziToast.min.css" rel="stylesheet">
    <!--<script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script src="../tchat/app.js"></script>-->
    <style>
        body{
            color: #113662;
        }
        body:before{
            background :#8cb743 ;
        }
        .full-chat-w .chat-content-w .chat-message .chat-message-content{
            background-color :rgba(140,183,67,0.1);
            color: #113662;
        }
        .full-chat-w .chat-content-w .chat-message.self .chat-message-content{
            background-color :rgba(112, 173, 229, 0.13);
            color: #113662;
        }
        .full-chat-w .user-intro .user-intro-info .user-name{
            color: #113662;
        }
        .user-date{
            color: #113662;
        }
        .full-chat-w .chat-info-section .ci-header span {
            color: #113662;
        }
        a{
            color: #113662;
        }
        .menu-and-user
         {
            color: rgba(255, 255, 255, 0.9);
            background-image: -webkit-gradient(linear, left top, left bottom, from(#113662), to(#113662));
            background-image: linear-gradient(to bottom, #113662 0%, #113662 100%);
            background-repeat: repeat-x;
        }
        .menu-side-compact-w.color-scheme-dark ul.main-menu .icon-w{
            color: #9db1ff;
        }
        .menu-side-compact-w.color-scheme-dark ul.main-menu > li.active >a .icon-w{
            color: #113662;
        }

        a:focus, a:hover {
            color: #113662;
            text-decoration: none;
        }
        .menu-top-w .menu-top-i ul.main-menu > li.has-sub-menu.active > a {
            background-color: #fff !important;
            color: #181e2e !important;
        }

        .menu-top-w .menu-top-i ul.main-menu > li.has-sub-menu.active > a .icon-w {
            color: #181e2e;
        }

        .menu-side-compact-w ul.main-menu > li.active > a {
            background-color: #fff;
        }
    </style>
</head>
<body>
<div class="all-wrapper menu-side no-padding-content">
    <div class="layout-w">
        <!--------------------
        START - Mobile Menu
        -------------------->
        <div th:replace="fragments/fragment-menu-mobile-manager :: menu-mobile-manager"></div>

        <!--------------------
        END - Mobile Menu
        -------------------->
        <!--------------------
        START - Menu side compact
        -------------------->
        <div th:replace="fragments/fragment-menu-side-compact-manager :: menu-side-compact-manager"></div>
        <!--------------------
        END - Menu side compact
        -------------------->
        <div class="content-w">
            <div class="content-i">
                <div class="content-box">
                    <div class="full-chat-w">
                        <div class="full-chat-i">
                            <div class="full-chat-left">
                                <div class="os-tabs-w">
                                    <ul class="nav nav-tabs upper centered">
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#tab_sales"><i class="os-icon os-icon-ui-93"></i><span>CHATS</span></a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="chat-search">
                                    <div class="element-search">
                                        <input placeholder="Search users by name..." type="text" id="search">
                                    </div>
                                </div>
                                <div class="user-list">
                                    <div class="user-w" th:each="us: ${connected}" th:id="${us?.getId()}">
                                        <div class="avatar with-status status-green">
                                            <img alt="" src="../img/avatar1.jpg">
                                        </div>
                                        <div class="user-info" th:if="${us?.messagesEnvoyes != null}">
                                            <div class="user-date" th:if="${us?.messageNonLu > 0}" th:text="${us?.messageNonLu} " id="colorMsgNonLu" style="background-color: #24d019">3</div>
                                            <div class="user-date" th:if="${us?.messageNonLu == 0}" th:text="${us?.messageNonLu} ? ${messageNonLu}: '0'">3</div>
                                            <div class="user-name" th:text="${us?.lastname}">nom et prenom</div>
                                            <div class="last-message" th:each="message, iterStat : ${us?.messagesEnvoyes}" th:if="${iterStat.index >= iterStat.size-1}" th:text="${#strings.abbreviate(message?.content,60)}" >
                                                message
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <div class="full-chat-middle" id="contenu-middle">
                                    <div class="chat-head">
                                        <div class="user-info">
                                            <span>A:</span><a href="#" id="destName"></a>
                                            <input type="hidden" id="destinataireUsername">
                                        </div>
                                    </div>
                                    <div class="chat-content-w">
                                        <div class="chat-content">
                                        </div>
                                    </div>
                                    <div class="chat-controls">
                                        <div class="chat-input">
                                            <input class="message-input" placeholder="Tapez votre message ici..." type="text">
                                            <input type="hidden" id="expediteurUsername" th:value="${expediteurUsername}" >

                                        </div>
                                        <div class="chat-input-extra">
                                            <div class="chat-extra-actions">
                                            </div>
                                            <!--<div class="chat-btn">
                                                <a class="btn btn-primary btn-sm" href="#">Repondre</a>
                                            </div>-->
                                        </div>
                                    </div>
                                </div>
                                <div class="full-chat-right" id="contenu-right">
                                    <div class="user-intro">
                                        <div class="avatar">
                                            <img alt="" src="../img/avatar1.jpg">
                                        </div>
                                        <div class="user-intro-info">
                                            <h5 class="user-name" id="user_name"> </h5>
                                            <br/>
                                            <table>
                                                <tbody>
                                                <tr><td align="left"><span style="font-weight:bold">Tél:</span></td><td  id="phone"></td></tr>
                                                <tr><td align="left"><span style="font-weight:bold">Email:</span></td><td  id="email"></td></tr>
                                                <tr><td align="left"><span style="font-weight:bold">Adresse:</span></td><td  id="address"></td></tr>
                                                <tr><td align="left"><span style="font-weight:bold">Mat:</span></td><td  id="matricule"></td></tr>
                                                <tr><td align="left"><span style="font-weight:bold">Né(e):</span></td><td  id="birthdate"></td></tr>
                                                <tr><td align="left"><span style="font-weight:bold">Login:</span></td><td  id="username"></td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="chat-info-section">
                                        <div class="ci-header">
                                            <i class="os-icon os-icon-documents-03"></i><span>Contrats</span>
                                        </div>
                                        <div class="ci-content">
                                            <div class="ci-file-list" id="liste_contrat">
                                                <ul ></ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chat-info-section">
                                        <div class="ci-header">
                                            <i class="os-icon os-icon-documents-07"></i><span>AUTRE</span>
                                        </div>
                                        <div class="ci-content">
                                            <div class="ci-file-list">
                                                <table>
                                                    <tbody>
                                                    <tr><td align="left"><span style="font-weight:bold">Cotisation annuelle : </span></td><td  id="cotisationAnnuelle"></td></tr>
                                                    <tr><td align="left"><span style="font-weight:bold">Cumul prime : </span></td><td  id="cumulPrime"></td></tr>
                                                    <tr><td align="left"><span style="font-weight:bold">Capital au : </span></td><td  id="capital"></td></tr>
                                                    <tr><td align="left"><span style="font-weight:bold">Interet : </span></td><td  id="interet"></td></tr>
                                                    <tr><td align="left"><span style="font-weight:bold">Prime nette : </span></td><td  id="primeNette"></td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="display-type"></div>
</div>
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/moment/moment.js"></script>
<script src="../bower_components/chart.js/dist/Chart.min.js"></script>
<script src="../bower_components/select2/dist/js/select2.full.min.js"></script>
<script src="../bower_components/ckeditor/ckeditor.js"></script>
<script src="../bower_components/bootstrap-validator/dist/validator.min.js"></script>
<script src="../bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>
<script src="../bower_components/dropzone/dist/dropzone.js"></script>
<script src="../bower_components/editable-table/mindmup-editabletable.js"></script>
<script src="../bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="../bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script src="../bower_components/fullcalendar/dist/fullcalendar.min.js"></script>
<script src="../bower_components/perfect-scrollbar/js/perfect-scrollbar.jquery.min.js"></script>
<script src="../bower_components/tether/dist/js/tether.min.js"></script>
<script src="../bower_components/bootstrap/js/dist/util.js"></script>
<script src="../bower_components/bootstrap/js/dist/alert.js"></script>
<script src="../bower_components/bootstrap/js/dist/button.js"></script>
<script src="../bower_components/bootstrap/js/dist/carousel.js"></script>
<script src="../bower_components/bootstrap/js/dist/collapse.js"></script>
<script src="../bower_components/bootstrap/js/dist/dropdown.js"></script>
<script src="../bower_components/bootstrap/js/dist/modal.js"></script>
<script src="../bower_components/bootstrap/js/dist/tab.js"></script>
<script src="../bower_components/bootstrap/js/dist/tooltip.js"></script>
<script src="../bower_components/bootstrap/js/dist/popover.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script src="../js/popup.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.1.5/js/iziToast.min.js"></script>
<script src="../js/main.js"></script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXXX-9', 'auto');
    ga('send', 'pageview');
</script>

<script>

    var stompClient = null;
    var lastMsg="vide";


    $(document).on('click', '.user-w', function(e) {
        var val = $(this).attr('id');
        console.log(val);
       // console.log(e.id);
        $.ajax({
            url: '/api/v1/sahamvie/user-message',
            type: 'POST',
            data: 'id=' + val,
            dataType: 'json',
            beforeSend: function () {

            },
            success: function (data) {
                console.log(data);
                if(!data.response.error){
                    $("#cotisationAnnuelle").html(data.data.cotisationAnnuelle);
                    $("#cumulPrime").html(data.data.cumulPrimeAu31122016);
                    $("#capital").html(data.data.capitalAu);
                    $("#interet").html(data.data.interet);
                    $("#primeNette").html(data.data.primeNette);
                    $("#destName").html(data.data.dest_lastName);
                    $("#user_name").html(data.data.dest_lastName);
                    $('#phone').html(data.data.phone);
                    $('#email').html(data.data.email);
                    $('#address').html(data.data.address);
                    $('#matricule').html(data.data.matricule);
                    $('#birthdate').html(data.data.birthdate);
                    $('#username').html(data.data.username);
                    $("#destinataireUsername").val(data.data.dest_username);
                    $("#expediteurUsername").val(data.data.exp_username);
                    $( ".chat-content" ).empty();
                    $( "#liste_contrat ul" ).empty();
                    $("#colorMsgNonLu").css('background-color','#fff');
                    $.each(data.data.expediteurContratList, function(i, item) {
                        $('#liste_contrat ul').append('<li><span>' +data.data.expediteurContratList[i].police+ '</span></li>');
                        return i<3;
                    }),
                        $.each(data.data.messages, function(i, item) {
                            if(data.data.messages[i].expediteur.toUpperCase() === $("#expediteurUsername").val().toUpperCase()){
                                $('.chat-content').append('<div class="chat-message self"><div class="chat-message-content-w"><div class="chat-message-content">' + data.data.messages[i].contenu + '</div></div></div>');
                            }else {
                                $('.chat-content').append('<div class="chat-message"><div class="chat-message-content-w"><div class="chat-message-content">' + data.data.messages[i].contenu + '</div></div></div>');
                            }
                            console.log(data.data.messages[i].contenu);
                        }),
                        connect();
                }
                var $messages_w = $('.chat-content-w');
                $messages_w.scrollTop($messages_w.prop("scrollHeight"));
                $messages_w.perfectScrollbar('update');
                return false;
                //content_middle.html(data)
            },
            complete: function () {
            },
            error: function (jqXHR) {
                //content.html(jqXHR.responseText);
            }
        })

    });

$('#search').on('keypress',function (e) {
    if(e.which == 13){
        console.log($(this).val());
        var val = $(this).val();
        $.ajax({
            url: '/api/v1/sahamvie/user/search',
            type: 'POST',
            data: 'name=' + val,
            dataType: 'json',
            beforeSend: function () {

            },
            success: function (data) {
                console.log(data);
                if(!data.response.error){
                    $('.user-list').empty();
                    $.each(data.data , function (i, item) {

                        if (data.data[i].firstname === null && data.data[i].lastname === null){
                        }else {
                            $('.user-list').append('<div class="user-w"  id="'+data.data[i].id +'">\n' +
                                '                            <div class="avatar with-status status-green"><img alt="" src="../img/avatar1.jpg"></div>\n' +
                                '                            <div class="user-info">\n' +
                                '                                  <div class="user-date"   id="colorMsgNonLu" style="background-color: #24d019">' + data.data[i].messageNonLu + '</div>\n' +
                                '                                  <div class="user-name">' + data.data[i].firstname + ' '+data.data[i].lastname+'</div>\n' +
                                '                            </div>\n' +
                                '                   </div>');
                        }

                    })

                }
            },
            complete: function () {
            },
            error: function (jqXHR) {
                //content.html(jqXHR.responseText);
            }
        })

    }

});

   function connect() {
        var socket = new SockJS('/gs-guide-websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            //setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/greetings', function (greeting) {
                console.log("..........");
                console.log(greeting);
                console.log(".............");
                showGreeting(JSON.parse(greeting.body));
            });
        });
    }

    $('.message-input').on('keypress', function (e) {
        if (e.which == 13) {
            stompClient.send("/app/hello", {}, JSON.stringify({'expediteur': $("#expediteurUsername").val(),'contenu':$(this).val(),'destinataire':$("#destinataireUsername").val()}));
            $(this).val('');
            var $messages_w = $('.chat-content-w');
            $messages_w.scrollTop($messages_w.prop("scrollHeight"));
            $messages_w.perfectScrollbar('update');
            return false;
        }
    });


   function showGreeting(message) {
        var areEqual = $("#expediteurUsername").val().toUpperCase() === message.expediteur.toUpperCase();
        lastMsg = message.expediteur;
        var areEqual2 = lastMsg.toUpperCase() === message.expediteur.toUpperCase();
        if(areEqual){
            console.log("identique");
            $('.chat-content').append('<div class="chat-message self"><div class="chat-message-content-w"><div class="chat-message-content">' + message.contenu + '</div></div></div>');
        }else {
            console.log("different");
            $('.chat-content').append('<div class="chat-message"><div class="chat-message-content-w"><div class="chat-message-content">' + message.contenu + '</div></div></div>');
        }
    }

</script>
</body>
</html>
